#!/usr/bin/env bash

. colors

export LD_LIBRARY_PATH=/hive/lib


[[ ! -e $RIG_CONF ]] && echo -e "${RED}No rig config $RIG_CONF${NOCOLOR}" && exit 1
[[ ! -e $WALLET_CONF ]] && echo -e "${RED}No wallet config $WALLET_CONF${NOCOLOR}" && exit 1

. $RIG_CONF
. $WALLET_CONF



# Check arguments and miner
MINER_NAME=$1
[[ -z $MINER_NAME ]] && "${RED}Give some miner name${NOCOLOR}" && exit 1


MINER_DIR=/hive/miners/$MINER_NAME
[[ ! -e $MINER_DIR ]] && "${RED}$MINER_DIR does not exist, check miner installation${NOCOLOR}" && exit 1


#TODO:
#TODO:
#TODO: check package installation
#TODO:
#TODO:



LIBCURL3_COMPAT=

[[ ! -e $MINER_DIR/h-manifest.conf ]] && echo -e "${RED}No $MINER_DIR/h-manifest.conf${NOCOLOR}" && exit 1
source $MINER_DIR/h-manifest.conf

#Ubuntu 18.04 compat
[[ $LIBCURL3_COMPAT == 1 && -e /usr/lib/x86_64-linux-gnu/libcurl-compat.so.3.0.0 ]] &&
	export LD_PRELOAD=libcurl-compat.so.3.0.0



#ps aux | grep -v grep | grep -v $$ | grep -q "/hive/bin/miner-run $MINER_NAME" &&
#	echo -e "${RED}$MINER_NAME miner is already running${NOCOLOR}" &&
#	exit 1



# Checks in taget of symlink exists
function mkfile_from_symlink() {
	[[ -z $1 ]] && return 1
	[[ ! -L $1 ]] && return 1 #not a symlink
	[[ -e $1 ]] && return 0 #symlink point to existing file
	local f=`readlink "$1"`
	local d=`dirname "$f"`
	[[ ! -d $d ]] && mkdir -p "$d" #&& echo "Creating $d"
	touch $f #&& echo "Touching $f"
	chown -R user "$d"
}



if [[ ! -e $MINER_DIR/h-config.sh ]]; then
	echo -e "${RED}No custom config generator${NOCOLOR}" && return 1
else
	unset -f miner_config_gen
	unset -f miner_ver
	unset -f miner_config_echo
	source $MINER_DIR/h-config.sh

	# exports needed by envsubst
	export MINER_VER=`miner_ver`
	export MINER_API_PORT
	export MINER_LOG_BASENAME

	miner_config_gen
fi


cd $MINER_DIR
while true; do
	[[ ! -e $MINER_DIR/h-run.sh ]] &&
		echo -e "${RED}$MINER_DIR/h-run.sh is not implemented${NOCOLOR}" &&
		sleep 3 &&
		continue

	miner logrotate $MINER_NAME

	source $MINER_DIR/h-run.sh

	echo ""
	echo -e "${YELLOW}$MINER_NAME exited, waiting to cooldown a bit${NOCOLOR}"
	echo ""
	sleep 3
done
